# PatrolSpectatorPlugin

A Paper/Spigot plugin for streaming: it cycles your perspective across online players so viewers can see what's happening on the server. Designed for "hands‑free" patrol during streams while you are AFK.

## 配信コンセプト
**「誰でも参加OK」無法サバイバル鯖｜荒らし・PK歓迎のマイクラ参加型**

### YouTubeタイトル・説明欄
```
【誰でも参加OK】無法サバイバル鯖｜荒らし・PK歓迎のマイクラ参加型

⚔ 参加型マイクラ 無法地帯サバイバル ⚔
BE版・JAVA版どちらでも参加可能！荒らし・PVP・PK・略奪・チート なんでもOKのサーバーで自由に遊ぼう！

📌 サーバーアドレス
otougame.falixsrv.me

📌 ルール
・荒らし、PVP、チート自由
・禁止事項：配信妨害、過度な暴言
・楽しく自由に！自己防衛必須！

📌 参加方法
1. Minecraftを起動（BE版 or JAVA版）
2. マルチプレイからサーバー追加
3. アドレスに「otougame.falixsrv.me」を入力して接続

💬 コメント歓迎！初見さんも気軽に参加してね！
```

### 配信の特徴
- **参加型配信**: 視聴者が実際にサーバーに参加可能
- **無法地帯**: 荒らし・PVP・PK・略奪・チート自由
- **双方向性**: コメントとゲーム内アクションの連動
- **自動化**: 12時間毎の自動配信再開で視聴者維持

## 🎮 参加率向上システム（新機能）

### 🎯 EngagementSystem（エンゲージメントシステム）
**新規参加者歓迎機能**
- 🎉 初回参加者に記念品を自動配布
  - 新規参加者記念剣
  - ウェルカムパン
  - 安全の松明
- 👋 全プレイヤーに新規参加者を通知

**参加者数報酬システム**
- 🎊 参加者数に応じた自動報酬配布
  - 1人達成：パン + 松明
  - 3人達成：鉄インゴット + 焼き肉
  - 5人達成：金インゴット + パン
  - 10人達成：ダイヤモンド + 金リンゴ
  - 15人達成：ネザライト + エンチャント金リンゴ
  - 20人達成：ネザライト + エンチャント金リンゴ

**個人報酬システム（一人でもコツコツ貯められる）**
- 🏆 個人達成に応じた自動報酬配布
  - 30分参加：鉄インゴット x30
  - 1時間参加：金インゴット x50
  - 3時間参加：ダイヤモンド x100
  - 5時間参加：ネザライト x200
  - 10回参加：経験値ボトル x50
  - 50回参加：エンチャント金リンゴ x100

**累計生存時間ランキング専用報酬（新機能）**
- 🔥 累計生存時間に応じた特別報酬配布
  - 10時間生存：ネザライトソード x1（ランキング+50ポイント）
  - 24時間生存：エンチャント金リンゴ x64（ランキング+100ポイント）
  - 50時間生存：ダイヤモンド x8（ランキング+200ポイント）
  - 100時間生存：ネザライトインゴット x4（ランキング+500ポイント）
- 🎉 全サーバーに達成通知
- 📊 累計生存時間ランキングのモチベーション向上

**長時間参加報酬**
- ⏰ 1時間参加者に特別報酬
  - 経験値ボトル
  - 金リンゴ
- 🎉 全プレイヤーに長時間参加を通知

**個人統計機能**
- 📈 参加時間・参加回数の記録
- 📊 `/patrol engagement` で個人統計表示

### 🎮 AutoEventSystem（自動イベントシステム）
**完全自動化された4種類のイベント**
1. **🏹 モブハント大会**
   - モンスターを倒してポイント獲得（PK数ランキングには影響しない）
   - キルストリークボーナス（30秒以内の連続キル）
   - モブ別ポイント：ゾンビ10、エンダーマン20、ガスト40、エンダードラゴン100
   - 弓・矢・焼き肉を配布

2. **⛏️ 採掘大会**
   - 貴重な鉱石を掘ってポイント獲得
   - ダイヤモンド鉱石：50ポイント
   - エメラルド鉱石：30ポイント
   - 鉄ピッケル・松明・パンを配布

3. **💀 サバイバルチャレンジ**
   - 生き残り時間でポイント獲得
   - 10秒ごとに1ポイント
   - 金リンゴ・鉄チェストプレート・盾を配布

4. **🏃 スピード大会**
   - 移動距離でポイント獲得
   - 移動するたびに1ポイント
   - スピードポーション・革ブーツ・焼き肉を配布

**自動化機能**
- ⏰ 1時間ごとにランダムイベント自動開始
- 🏆 15分間の制限時間で自動終了
- 📊 3分ごとに進捗自動表示
- 🎁 上位3位に特別報酬自動配布

**管理コマンド**
- `/patrol autoevent status` - イベント状況確認
- `/patrol autoevent stop` - 自動イベント停止
- `/patrol autoevent start` - 自動イベント開始

### 📋 ルール表示システム（新機能）
**自動ルール表示**
- ⏰ 30分ごとにサーバールールを自動表示
- 📋 基本ルール・システム説明・コマンド一覧を表示
- 🎯 参加率向上システムの詳細説明
- 🎮 自動イベントシステムの詳細説明
- 🏆 ランキングシステムの詳細説明
- ⌨️ 利用可能コマンドの一覧表示
- 🌐 日本語・英語の多言語対応

## 修正履歴

### v1.3.0 (2025年1月) - 参加率向上システム追加版
**新機能**:
- **🎯 EngagementSystem**: 新規参加者歓迎・参加者数報酬・長時間参加報酬システム
- **🎮 AutoEventSystem**: 完全自動化された4種類のイベントシステム
- **📊 個人統計機能**: 参加時間・参加回数の記録と表示
- **🎁 自動報酬配布**: 参加者数・長時間参加・イベント上位者への自動報酬

**参加率向上の工夫**:
- 新規参加者の歓迎と記念品配布
- 参加者数に応じた全員報酬
- 長時間参加者の特別報酬
- 10分ごとの自動イベントで継続的な楽しさ
- 完全自動化で管理作業不要

### v0.9.2 (2025年1月27日) - ログ削減版
**修正内容**:
- **ログ削減**: 頻繁に出力されるログを削除
- **getPatrollerログ削除**: 「パトローラーが見つからない」ログを削除
- **設定監視ログ削除**: 正常動作ログを削除
- **AFK防止ログ削除**: アクティビティ記録ログを削除
- **Patrol停止ログ削除**: 停止中のログを削除

**ログ削減対象**:
- パトローラーが見つからないログ
- 設定監視の正常動作ログ
- AFK防止のアクティビティ記録ログ
- Patrol停止中のログ

### v1.2.2 (2025年8月23日) - エンドワールド自動リセット版
**修正内容**:
- **【エンドラ討伐後自動リセット】**: エンドラ討伐後にエンドワールドを自動リセット
  - エンドラ討伐から5分後に自動リセット
  - エンドワールドの全エンティティを削除
  - エンドワールドにいるプレイヤーをオーバーワールドにテレポート
  - リセット予告と完了通知を全プレイヤーに送信
- **ランキング除外機能の修正**: パトローラーのみをランキングから除外
  - 除外リストは視点制御専用（ランキングには影響しない）
  - より正確なランキング記録が可能

**新機能**:
- **scheduleEndWorldReset()**: エンドワールドリセットのスケジュール
- **executeEndWorldReset()**: エンドワールドリセットの実行
- **自動テレポート**: エンドワールドのプレイヤーを安全にオーバーワールドに移動

**改善効果**:
- エンドラ討伐後に自動でエンドワールドがリセットされる
- プレイヤーは安全にオーバーワールドにテレポートされる
- エンドラが再出現可能になり、ゲームが継続できる

### v1.2.1 (2025年8月23日) - 観光地自動取得強化版
**修正内容**:
- **【観光地自動取得】**: 実際の建造物座標を取得して観光地に自動追加
  - 海底神殿、村、略奪者の前哨基地、森の洋館を自動検索
  - ネザー要塞、砦の遺跡、エンドシティも対応
  - 非同期処理でサーバーパフォーマンスを保護
- **観光地管理コマンド強化**: 3つの新しいコマンドを追加
  - `/patrol listlocations` - 観光地一覧表示（アイコン付き）
  - `/patrol reloadlocations` - 観光地の再初期化
  - `/patrol teleportlocation <番号>` - 指定観光地へテレポート

**新機能**:
- **findAndAddStructure()**: 実際の建造物座標を検索・追加
- **getStructureType()**: 建造物タイプの安全な取得
- **非同期処理**: メインスレッドをブロックしない建造物検索

**改善効果**:
- 観光地が実際の建造物の場所に正確に設定される
- 観光地の管理・確認が簡単になる
- サーバーパフォーマンスが向上する

### v1.2.0 (2025年8月23日) - ランキング除外3段階対策版
**修正内容**:
- **【3段階除外対策】**: 実行者IDをランキングから完全除外
  - **第1段階**: コマンド実行者はカウントしない
  - **第2段階**: 保存されていたら削除する
  - **第3段階**: 万が一保存してるリストに入ってても除外しない
- **自動データクリーンアップ**: プラグイン起動時に除外対象の既存データを自動削除
- **全イベント除外対応**: 参加・死亡・PK・エンドラ討伐の全イベントで除外処理
- **手動クリーンアップコマンド**: 3つの新しいコマンドを追加
  - `/patrol clearpatrollerdata` - パトローラーデータ削除
  - `/patrol clearexcludeddata` - 除外リストデータ削除
  - `/patrol clearplayerdata <プレイヤー名>` - 指定プレイヤーデータ削除

**新機能**:
- **isPlayerExcluded()**: 3段階チェックによる除外判定
- **cleanupPatrollerData()**: 完全データ削除機能
- **cleanupExcludedPlayersData()**: 除外リスト一括削除

**改善効果**:
- 実行者IDがランキングに表示されることが完全に防止される
- 既存のデータも自動的にクリーンアップされる
- 手動でのデータ管理が可能になる

### v1.1.6 (2025年8月19日) - エンドラ討伐検知強化版
**修正内容**:
- **エンドラ討伐検知強化**: デバッグログ追加、Title表示、代替検知機能実装
- **手動記録コマンド**: `/patrol dragon <プレイヤー名>` で手動でエンドラ討伐を記録
- **OP権限チェック**: `/patrol`と`/spectate`コマンドにOP権限が必要
- **通知の改善**: エンドラ討伐時にTitle表示とチャット通知を強化
- **データ即座保存**: エンドラ討伐時にランキングデータを即座に保存

**新機能**:
- **代替検知システム**: EntityDeathEventの補完機能で確実な検知
- **手動記録**: 検知が漏れた場合の手動記録機能
- **権限管理**: OP権限によるコマンド制限

**改善効果**:
- エンドラ討伐の検知精度が大幅向上
- 配信での視認性が向上（Title表示）
- セキュリティが向上（OP権限チェック）

### v0.9.4 (2025年1月27日) - PK記録機能実装版
**修正内容**:
- **PK記録機能実装**: プレイヤーキルイベントを検知してPK数を記録
- **過去記録対応**: PK数ランキングに過去の記録も含める
- **リアルタイム通知**: PK発生時に全プレイヤーに通知
- **データ永続化**: PK数もJSONファイルに保存・読み込み

**改善効果**:
- 実際のPKがランキングに反映される
- 過去の参加者のPK記録も保持される
- 配信でのPKシーンがより盛り上がる

### v0.9.3 (2025年1月27日) - ランキング表示改善版
**修正内容**:
- **Title表示追加**: ランキングを大きな文字でTitle表示
- **視認性向上**: チャット表示に区切り線を追加
- **段階的表示**: 5秒間隔で各ランキングを順次表示
- **文字サイズ改善**: プレイヤー名を白色で強調表示
- **演出強化**: ランキング発表の演出を改善

**改善効果**:
- 配信での視認性が大幅に向上
- 視聴者がランキングを確認しやすくなる
- より魅力的なランキング発表演出

### v0.9.2 (2025年1月27日) - ログ削減版
**修正内容**:
- **ログ削減**: 頻繁に出力されるログを大幅に削減
- **isEligibleログ削除**: プレイヤー判定の詳細ログを削除
- **設定監視ログ削減**: 正常動作ログを10分間隔に変更
- **AFK防止ログ削減**: アクティビティ記録を30分間隔に変更
- **Patrol停止ログ削除**: 不要な停止ログを削除

**ログ削減効果**:
- コンソールログの量を大幅に削減
- 重要なエラーログは保持
- サーバー性能への影響を軽減

### v0.9.1 (2025年1月27日) - ランキングシステム実装版
**新機能**:
- **累計生存時間ランキング**: プレイヤーの累計生存時間を記録・表示
- **PK数ランキング**: プレイヤーのキル数を記録・表示  
- **エンドラ討伐数ランキング**: エンドラ討伐数を記録・表示
- **データ永続化**: JSONファイルでランキングデータを保存（ワールドリセット後も保持）
- **自動保存**: 10分間隔でランキングデータを自動保存
- **オンライン/オフライン表示**: ランキングに🟢（オンライン）/⚫（オフライン）を表示
- **YouTube視聴促進**: ランキング表示時に配信案内を表示

**ランキング仕様**:
- **累計生存時間**: 死んでもリセットされない累計時間
- **データ保持**: ワールドリセット後もPluginフォルダに保存される
- **表示間隔**: 5分間隔でランキングを表示
- **保存間隔**: 10分間隔でデータを自動保存
- **表示形式**: 上位3名をメダル付きで表示

**データファイル**:
- 保存場所: `plugins/PatrolSpectatorPlugin/ranking_data.json`
- 形式: JSON形式
- 内容: プレイヤー名、累計生存時間、キル数、デス数、エンドラ討伐数

**ワールドリセット対応**:
- **ワールドデータ**: リセットされる（`world/` フォルダ）
- **Pluginデータ**: 保持される（`plugins/PatrolSpectatorPlugin/` フォルダ）
- **ランキングデータ**: 完全に保持される（JSONファイル）

### v0.9.0 (2025年1月27日) - ランキングシステム基礎版
**新機能**:
- **生存時間ランキング**: プレイヤーの生存時間を記録・表示
- **PK数ランキング**: プレイヤーのキル数を記録・表示
- **エンドラ討伐数ランキング**: エンドラ討伐数を記録・表示
- **累計データ**: 死んでもリセットされない累計記録
- **オフライン対応**: 参加していないプレイヤーもランキングに表示
- **YouTube視聴促進**: ランキング表示で配信案内

**ランキング表示**:
- 5分間隔で自動表示
- 上位3名をメダル付きで表示
- オンライン/オフライン状態を表示
- サーバー参加案内を表示

### v0.8.8 (2025年1月27日) - 視点表示改善版
**修正内容**:
- **視点表示の改善**: 「〇〇視点」の文字サイズを大きく
- **アイコン追加**: 🎯アイコンを追加して視認性向上
- **色の変更**: より目立つ色（GOLD、YELLOW）に変更

### v0.8.7 (2025年1月27日) - 無記入テキスト完全削除版
**修正内容**:
- **無記入テキスト完全削除**: `player.sendMessage("")` を完全に削除
- **画面の揺れ完全修正**: 参加者への影響を完全に排除

### v0.8.6 (2025年1月27日) - 条件付き設定変更版
**修正内容**:
- **条件付き設定変更**: PatrolがSTARTしている時のみ`player-idle-timeout=0`を設定
- **ゲームルール削除**: `doDaylightCycle`と`playersSleepingPercentage`の設定を完全削除
- **自然な時間経過**: サーバーの自然な昼夜サイクルを復活

### v0.8.5 (2025年1月27日) - 設定監視強化版
**修正内容**:
- **設定監視強化**: 10秒間隔で`player-idle-timeout`を監視・修正
- **詳細ログ**: 設定変更時の警告ログとタイムスタンプ
- **自動開始**: プラグイン起動時に設定監視を自動開始

### v0.8.4 (2025年1月27日) - AFK防止再評価版
**修正内容**:
- **AFK防止再評価**: 最小限のAFK防止アクションを復活
- **頻度調整**: 2.5秒間隔に調整（5秒→2.5秒）
- **確実性重視**: 無操作検知回避を確実に動作させる

### v0.8.3 (2025年1月27日) - 参加者への影響完全排除版
**修正内容**:
- **参加者への影響排除**: スニーク状態変更を削除（参加者に見える動作を完全排除）
- **実行頻度削減**: 0.5秒→5秒間隔に変更（より静かに）
- **完全に静かなAFK防止**: スイングアクションのみ（参加者には見えない）

**参加者への影響**:
- **v0.8.2以前**: スニーク状態変更で参加者に見える
- **v0.8.3**: 参加者には完全に見えない（スイングアクションのみ）

**動作確認**:
- 配信者: スイングアクションのみ（見えない）
- 参加者: 何も見えない（完全に静か）

### v0.8.2 (2025年1月27日) - 画面揺れ・無記入テキスト修正版
**修正内容**:
- **画面の揺れ修正**: 頻繁なテレポート処理を削除
- **無記入テキスト修正**: 空のメッセージ送信処理を削除
- **AFK防止の静か化**: スイングアクションとスニークのみに簡素化
- **不要な処理削除**: ブロック操作、インベントリ操作、ワールド変更を削除

**問題の原因**:
- `p.sendMessage("")` で無記入テキストが流れる
- `p.teleport(loc)` で画面が揺れる
- 過度なAFK防止処理でゲームプレイに支障

**修正後の動作**:
- 静かなAFK防止（スイング・スニークのみ）
- 画面の揺れなし
- 無記入テキストなし
- ゲームプレイに支障なし

## Background / Use case
- The streamer joins the server and runs `/patrol start`.
- The plugin automatically switches the streamer's perspective to another player at a fixed interval.
- Optionally broadcasts who is currently being watched so viewers and players know the context.
- Spectator camera mode can be used (recommended), or simple teleport.
- Players with the exempt permission are skipped (staff, privacy‑sensitive users, etc.).

This project lives under its own directory `PatrolSpectatorPlugin/` and does not modify other projects, so it will not affect your existing development.

## Build
```bash
sudo apt-get update && sudo apt-get install -y maven   # once
cd /home/gonjy/projects/PatrolSpectatorPlugin
mvn -q -DskipTests package
```
Jar: `target/patrol-spectator-plugin-1.1.6.jar`

## Install
- Copy the jar to the server `plugins/` folder
- Start the server

## Commands
- `/spectate` — toggle spectator/survival (OP権限必要)
- `/patrol` or `/patrol next` — switch to next target (OP権限必要)
- `/patrol start [seconds]` — start auto‑patrol with interval (default from config) (OP権限必要)
- `/patrol stop` — stop auto‑patrol (OP権限必要)
- `/patrol rebuild` — rebuild target order from current eligible players (OP権限必要)
- `/patrol list` — show current patrol order (OP権限必要)
- `/patrol reload` — reload config (OP権限必要)
- `/patrol dragon <プレイヤー名>` — 手動でエンドラ討伐を記録 (OP権限必要)

## Permissions
- `patrolspectator.use` (default: op) — use commands
- `patrolspectator.exempt` — excluded from being patrolled

## Configuration (`config.yml`)
```yaml
intervalSeconds: 10                # auto patrol interval
useSpectatorCamera: true           # use spectator camera instead of teleport
allowedWorlds: []                  # empty = all worlds
exemptPermission: patrolspectator.exempt
announceToPlayers: true            # broadcast the current target when switching
useTitle: true                     # use title for the patroller; otherwise action bar
announceFormat: "&7[Stream]&f Now watching: &a%target%"
```
Placeholders: `%target%` (watched player), `%patroller%` (you).

## Notes / Safety
- Spectator camera needs `gamemode spectator` permission for the patroller.
- Respect privacy: mark staff or private players with `patrolspectator.exempt`.
- If your stream is public, consider enabling `announceToPlayers` so players are aware when they are on camera.
